"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const y=require("react/jsx-runtime"),m=require("@react-three/fiber"),P=require("@react-three/postprocessing"),t=require("react"),i=require("three"),g=require("@takram/three-atmosphere/r3f"),E=require("@takram/three-geospatial"),l=require("./shared.cjs"),A=t.createContext(null),W=({layers:e,disableDefault:o=!1,children:d})=>{const[a,f]=t.useState();return t.useLayoutEffect(()=>{e.set(o?Array(4).fill(l.CloudLayer.DEFAULT):l.CloudLayers.DEFAULT),f({layers:e,indexPool:[0,1,2,3],disableDefault:o})},[e,o]),a!=null&&y.jsx(A.Provider,{value:a,children:d})};function w(e,o){const[d,a]=t.useState(typeof e!="string"?e:null);return t.useEffect(()=>{if(typeof e=="string"){const f=new i.TextureLoader;(async()=>{const r=await f.loadAsync(e);r.minFilter=i.LinearMipMapLinearFilter,r.magFilter=i.LinearFilter,r.wrapS=i.RepeatWrapping,r.wrapT=i.RepeatWrapping,r.colorSpace=i.NoColorSpace,r.needsUpdate=!0,o.initTexture(r),a(r)})().catch(r=>{console.error(r)})}else a(e)},[e,o]),d}function D(e,o){const[d,a]=t.useState(typeof e!="string"?e:null);return t.useEffect(()=>{if(typeof e=="string"){const f=E.createData3DTextureLoaderClass(E.parseUint8Array,{width:o,height:o,depth:o,format:i.RedFormat,minFilter:i.LinearFilter,magFilter:i.LinearFilter,wrapS:i.RepeatWrapping,wrapT:i.RepeatWrapping,wrapR:i.RepeatWrapping,colorSpace:i.NoColorSpace}),r=new f;(async()=>{a(await r.loadAsync(e))})().catch(p=>{console.error(p)})}else a(e)},[e,o]),d}function j(e){const[o,d]=t.useState(typeof e!="string"?e:null);return t.useEffect(()=>{if(typeof e=="string"){const a=new E.STBNLoader;(async()=>{d(await a.loadAsync(e))})().catch(f=>{console.error(f)})}else d(e)},[e]),o}const I=t.forwardRef(function({disableDefaultLayers:o=!1,localWeatherTexture:d=l.DEFAULT_LOCAL_WEATHER_URL,shapeTexture:a=l.DEFAULT_SHAPE_URL,shapeDetailTexture:f=l.DEFAULT_SHAPE_DETAIL_URL,turbulenceTexture:r=l.DEFAULT_TURBULENCE_URL,stbnTexture:p=E.DEFAULT_STBN_URL,children:L,...c},h){const{textures:u,transientStates:s,...T}=t.useContext(g.AtmosphereContext),[U,F]=g.separateProps({...l.cloudsPassOptionsDefaults,...T,...u,...c}),n=t.useMemo(()=>new l.CloudsEffect,[]);t.useEffect(()=>()=>{n.dispose()},[n]),m.useFrame(()=>{s!=null&&(n.sunDirection.copy(s.sunDirection),n.ellipsoidCenter.copy(s.ellipsoidCenter),n.ellipsoidMatrix.copy(s.ellipsoidMatrix))}),t.useEffect(()=>{if(s!=null)return s.overlay=n.atmosphereOverlay,s.shadow=n.atmosphereShadow,s.shadowLength=n.atmosphereShadowLength,()=>{s.overlay=null,s.shadow=null,s.shadowLength=null}},[n,s]);const x=t.useCallback(C=>{if(s!=null)switch(C.property){case"atmosphereOverlay":s.overlay=n.atmosphereOverlay;break;case"atmosphereShadow":s.shadow=n.atmosphereShadow;break;case"atmosphereShadowLength":s.shadowLength=n.atmosphereShadowLength;break}},[n,s]);t.useEffect(()=>(n.events.addEventListener("change",x),()=>{n.events.removeEventListener("change",x)}),[n,x]);const S=m.useThree(({gl:C})=>C),_=w(d,S),v=D(a,l.CLOUD_SHAPE_TEXTURE_SIZE),R=D(f,l.CLOUD_SHAPE_DETAIL_TEXTURE_SIZE),b=w(r,S),O=j(p),{camera:q}=t.useContext(P.EffectComposerContext);return y.jsxs(y.Fragment,{children:[y.jsx("primitive",{ref:h,object:n,mainCamera:q,...U,localWeatherTexture:_,shapeTexture:v,shapeDetailTexture:R,turbulenceTexture:b,stbnTexture:O,...F}),y.jsx(W,{layers:n.cloudLayers,disableDefault:o,children:L})]})}),M=t.forwardRef(function({index:o,...d},a){const f=t.useContext(A);if(f==null)throw new Error("CloudLayer can only be used within the Clouds component!");const{layers:r,indexPool:p,disableDefault:L}=f,[c,h]=t.useState();if(t.useLayoutEffect(()=>{if(o!=null){const u=p.indexOf(o);if(u!==-1)return p.splice(u,1),h(o),()=>{p.push(o),h(void 0)}}else{const u=p.sort((s,T)=>s-T).shift();if(u!=null)return h(u),()=>{p.push(u),h(void 0)}}},[o,r,p]),t.useLayoutEffect(()=>{if(c==null)return;const u=r[c];return()=>{u.copy(L?l.CloudLayer.DEFAULT:l.CloudLayers.DEFAULT[c])}},[r,c,L]),t.useEffect(()=>{c!=null&&(typeof a=="function"?a(r[c]):a!=null&&(a.current=r[c]))},[a,r,c]),c!=null){const u=r[c];u.copy(L?l.CloudLayer.DEFAULT:l.CloudLayers.DEFAULT[c]),u.set(d)}return null});exports.CloudLayer=M;exports.Clouds=I;
//# sourceMappingURL=r3f.cjs.map
